# 开发日志（2025-05-30 14:00）

**1. 项目初始化**
- 新建 `storybook-workflow` 目录，前后端完全独立，避免与历史项目混淆。
- 前端用 `create-react-app` 初始化，后端用 Flask + 本地JSON数据。

**2. 主流程开发**
- 按照"分步工作流"原型，完成4步主流程（基本信息、文案、分镜、图片）。
- 每一步为独立React组件，主流程用大卡片+顶部导航+卡片内进度条聚焦体验。

**3. 样式与UI重构**
- 全面引入 TailwindCSS，所有UI采用现代卡片、圆角、阴影、渐变背景。
- 顶部导航栏、按钮、表单全部美化，风格与 `ui草稿.html` 高度一致。
- 近期已完成主流程各步骤页面的UI细节优化，所有输入区、按钮、卡片均有主色调、阴影、hover/聚焦高亮，体验新手友好。

**4. 后端API与数据**
- 实现 `/api/styles` 风格模板API，前端下拉与模板预览全部联动。
- 后端数据本地JSON存储，便于新手维护和扩展。
- 前端已预留所有关键API（如`/api/generate_script`、`/api/generate_prompts`、`/api/generate_images`），数据流和props/context已打通。

**5. 辅助开发工具**
- 编写 `start-dev.ps1` 脚本，一键启动前后端开发服务，极大提升开发效率。

**6. 细节优化**
- LOGO品牌名支持自定义（已改为"罗森"）。
- 所有分步流程、表单、按钮均可扩展和美化。
- 主流程全局数据流已打通，支持草稿保存与恢复。

**7. Step1Script（故事文案创作页）数据流与API说明**
- 风格下拉框与Step0一致，均通过`/api/styles`获取风格列表，选项与后端JSON数据完全同步。
- 主题、适龄段、风格、关键词等参数支持回显和修改，数据可通过props/context从Step0传递。
- 点击"AI生成脚本"按钮，前端POST参数（style、age、theme、classic、keywords）到`/api/generate_script`，后端返回中英文脚本，分别填充到对应文本框。
- 支持手动编辑AI生成结果，便于用户微调。
- 交互流程清晰，UI与原型一致，便于新手理解和扩展。

**8. Step2Prompts（分镜提示词生成页）数据流与API说明**
- 页面接收上一步的"中文旁白"数组（scriptZhList），每个分镜显示对应旁白内容和提示词输入框。
- "AI生成"按钮调用`/api/generate_prompts`，参数为所有分镜的旁白、风格、主题等，后端返回提示词数组，自动填充到输入框。
- 用户可手动编辑每个分镜的提示词，支持保存、批量导出等操作。
- 结构与UI原型一致，交互清晰，便于新手理解和扩展。

**9. ComfyUI工作台与局部修改功能规划**
- 顶部菜单"工作台"专用于ComfyUI工作流相关功能，独立于主流程，便于AI图片实验和高级编辑。
- 新建ComfyUI工作台页面（ComfyUIWorkbench.jsx），支持图片上传、分镜提示词输入、参数配置、AI生成/编辑/局部修复等。
- 每张分镜图片下方增加"局部修改"按钮，弹窗或跳转到工作台，支持用户圈选区域（生成mask）、输入新提示词，调用后端inpaint接口实现局部修复。
- 后端API对接ComfyUI工作流，支持图片生成、局部编辑、风格迁移等。
- 典型流程：用户上传图片→圈选区域→输入提示词→提交→后端处理→返回新图片→前端展示。

**10. 主流程全局数据流与草稿保存规划**
- 采用全局状态（如React Context或顶层useState）管理主流程所有步骤数据，保证Step0~Step3间数据实时同步。
- 用户在任意步骤修改内容，后续步骤自动更新，避免数据丢失和不同步。
- 增加"保存草稿"功能，将当前全局数据序列化存入localStorage，用户可随时保存/恢复创作进度。
- 页面加载时自动检测草稿，支持一键恢复。
- 便于后续扩展多项目管理、团队协作等高级功能。

---

**当前状态：**
- 首页UI与原型高度一致，分步流程可用，风格美观。
- 主流程数据流和前端API联动已打通，体验新手友好。
- 前后端开发环境一键启动，适合新手持续开发。
- 后续可继续扩展仪表盘、风格管理、AI联动等功能。

---

**后端设置管理功能进展（2025-05-30）**
- 已实现 `/api/settings` 接口，支持前端设置和保存大模型API地址、密钥、模型名三项配置，兼容环境变量自动读取。
- 前端设置页已集成，支持API KEY显示/隐藏、模型名下拉实时获取、手动刷新、API连通性检测，检测结果友好提示。
- 所有配置本地JSON持久化，后端AI能力自动读取，所有AI能力均可动态切换配置。

---

**后续主线开发计划（2025-05-30起）**

1. **后端API梳理与实现**
   - 明确每个API的输入输出格式（如`/api/generate_script`、`/api/generate_prompts`、`/api/generate_images`等）。
   - 用Flask实现这些API，支持本地JSON数据读写、AI模型/第三方API调用（可先用mock/占位数据，逐步替换为真实AI）。

2. **数据存储与归档**
   - 设计本地JSON的结构，支持故事、分镜、图片等数据的增删查改。
   - 实现前后端数据的完整流转（如"保存"按钮真正写入本地JSON）。

3. **AI能力接入**
   - 优先实现"AI生成脚本""AI生成分镜提示词""AI生成图片"三大核心能力。
   - 可先用OpenAI API、或本地大模型API、或mock数据，逐步替换为真实AI。

4. **前后端联调，确保数据流闭环**
   - 前端各步数据与后端API全面打通，支持完整的创作流程。

---

**下阶段目标：**
- 优先让"AI生成脚本/分镜/图片"三大能力跑通，后端API与AI能力落地。
- 持续完善数据归档、ComfyUI工作台、团队协作等高级功能。 